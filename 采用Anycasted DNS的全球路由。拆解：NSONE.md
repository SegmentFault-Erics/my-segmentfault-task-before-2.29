### 采用Anycasted DNS的全球路由。拆解：NSONE ###

发帖者：Chris Ueland 　　　　　　　日期：2014.11.20

![标题图](http://2zmzkp23rtmx20a8qi485hmn.wpengine.netdna-cdn.com/wp-content/uploads/2014/11/Scalescale-Teardown-NSONE1_reduced-height.png)

应用　　　　　　　　　　　　　　　　　　　　自动化和检测

应用信息：　　　RabbitMQ　　　　　　　　　指标：　　　　OpenTSDB

数据库：　　　　MongoDB　　　　　　　　　大数据：　　　 HBase

高速缓存：　　　Redis　　　　　　　　　　　自动化工具：　 Ansible

DNS和路由　　　　　　　　　　　　　　　　　性能监控

DNS：　　　　　Python & C　　　　　　　　 Web性能：　　　Catchpoint

路由：　　　　　ExaBGP　　　　　　　　　　流量指标：　　　CloudHelix

---

我最初是通过[杰森阅读](http://www.scalescale.com/building-cloud-benchmarking-system/)见到Kris的。他曾在亚洲的Voxel/Internap工作很长时间。纽约时间早上10点，我们在印度第一次见面，当时我就感觉他很聪明，对于建设[NSONE](https://nsone.net/)也有宏伟的想法。本文尝试突破堆栈，或许可以为你提供灵感。

–Chris / ScaleScale / MaxCDN

---

### 什么使NSONE与众不同？ ###

NSONE是一个现代化DNS和流量管理平台。接下来，我们的任务是将你的眼球转移到合理的位置。这如同在全球基础上可靠且迅速地回答一个普通的旧DNS问题一样简单，也如同根据相关基础结构或互联网的各种实时遥测来快速详细的计算选择最好的潜在数据中心、CDN或者其它端点服务用户一样复杂。为了做到这些，我们已经构建并建立了一个全新的从底向上的DNS堆栈分发，同时在6大洲部署了一个世界级托管DNS的网络，并从根本上重新考虑了很多关于如何传统的使用和托管DNS。NSONE的硬件设施支持也同样很出色。我们从整个基础架构中得到深层背景：主机、云、按需裸机、中转、CDN等，这些我们已经完成了搭建。在回答简单问题时专业知识和观点是非常有效的：我们应该在哪里发送这些流量？总之，它能让你使用它时非常轻松，并且能得到来自他人和用户的尊重。

### 路由DNS如何，关于用户路由通信的有趣方式？ ###

如果你只是单单从一个数据中心下载应用程序，那么DNS路由就没什么了。但某个时刻有多个数据中心，你便面临选择——哪个端点将能最佳的服务用户——这时DNS路由就变得有意义了。 “最佳”是一个泛泛的术语：它可能是响应时间最快，或吞吐量最高，或数据包丢失最少，但它还可能是某些性能和商务标准的组合。

目前，大多数DNS路由正在做一些简单的假设，例如，物理位置最靠近用户的数据中心能提供最佳的服务。但互联网实际上并不是这样运作的，这也是非常短浅的理解“最佳”。

我们的观点是在做决策的时候，当我们对某些域的DNS查询，且有一些潜在的方案可以选择——通常是为你应用服务的服务端——我们应该获得尽可能多的终端信息。

主要信息分为三类：

1.静态数据：比如你服务器的位置在哪里，他们有多少核心，基本的优先级和权重等等；

2.基础指标：有关基础设施的实时信息，如负载平均值，负载平衡器的连接数据，提交信息的多少等等；

3.可视指标：用户和终端之间的实时交换信息，比如微小的延迟、吞吐量，最终用户的优势点或全球路由表的状态信息等等。

![终端信息图](http://2zmzkp23rtmx20a8qi485hmn.wpengine.netdna-cdn.com/wp-content/uploads/2014/11/data-driven-dns11.png)

我们建立的这套系统和平台要包含以上所有信息，通常在高频将它变成对路由有用的信息，并把它提取到DNS交付边缘作为近似的实时信息，因此它可以作出路由决策。

首先要做的是得到很多可用的路由数据，然后将数据变得简单可用，这便是Filter Chain技术。从更高一层来说，Filter Chain就像积木式“滤波器”算法的一个序列。每个滤波器检测一个DNS的一组应答和所有静态配置和指标，并且对这些应答进行处理：删除响应时间长的终端，根据请求者的网络响应时间分类，从过载服务器中摆脱等。按顺序连接这些滤波器时，通过基础应用的实时数据建立复杂的一站式路由设置就变得非常简单了。

我们用户将这项技术发挥的淋漓尽致，并经常寻找一些混合匹配数据的新方法和新算法来获得更好的效果。我们做一些这样的事情：选择一个区域（如US-WEST或US-EAST），在此区域内，分别向colo和AWS发送95％和5％的流量，因此为了保证高速缓存位置，大部分时间5％的用户选择AWS。如果colo出现过载现象，通过启用自动缩放来改变权重让过多的流量选择AWS。诸如此类。

这些功能自然地适合于多数据中心中对性能敏感的应用，所以我们做了CDNs的路由、广告技术公司、网络性能、SaaS平台等等很多类似的事情。不过说实话，从单一的数据中心的应用部署到两个或者更多数据中心，具有非常重要的意义。

### 堆栈方式？ ###

我们要对堆栈做很多事情。在输出侧，我们从硬件/NIC级接触数据（疯狂数据包过滤），在BGP中做深度流量工程，利用低内核功能到特定核心来获得尽可能精确的DNS路由查询，以便将缓存位置最大化，并且为每一个请求执行复杂的路由算法打造自定义编写域名服务器。在更高的层面上，我们建立了一个大型的全球分布式实时系统，也尝试使用合适的工具。有这么一些，如Mongo（善于复制，但我们在读/写上要求没那么高），RabbitMQ的（帮助我们快速传播配置的变化和路由数据到网络中的每一个域名服务器），还有Redis等等。在门户网站，API和中央系统等核心设施中，我们采用HBase和OpenTSDB作为指标。我们有很多自己的软件，大部主要有是Python（Twisted）。大概有20多个不同的作用。由Ansible管理，它对于速度至关重要。我们有一个非常可靠的QA/合理的构建框架和程序，具备全面的功能测试套件。

### 采用什么性能监控工具？ ###

我们主要监测工具是Catchpoint。同时为了明确怎样将流量连接到网络，我们在路由观点以及各种主干网的观测也花了很多时间。我们将越来越多的运用CloudHelix——这是一个强大的工具用来查询流量指标。

我们一般不会用那些简单的在线ping或者其它工具：他们经常错误的定位节点，换句话说他们计算的结果不可靠。我们也有自己一个非常著名的RUM设备，这也是我们高端路由技术的一部分，并且我们可以在整个用户网络中利用特殊方法得到非常精确的DNS性能数据。

### 如何布局网络？ ###

这是一个有趣的问题，因为在各种网络中NSONE运行着。我们真正要做的是部署专用工具，用来专门管理DNS网络，因此有各种各样的拓扑结构在作用。这个大型、全球性、管理DNS网络——大部分由用户使用——分布在六大洲，17个POPs（有的更多）。根据市场模式Anycasted有大约7-8种混合。我们真正大量使用BGP社区，并且与BGP社区政策提供者具体合作，所以我们可以非常精确的调整Anycasting。我做了很多工作，但现在我们是拥有这个星球上最快的DNS网络者之一。

![网络布局图](http://2zmzkp23rtmx20a8qi485hmn.wpengine.netdna-cdn.com/wp-content/uploads/2014/11/nsone-map41.png)

当你在构建一个全球性的Anycasted网络，你真正关心的是运营商拓扑距离——尤其是所有大的主干网。当我们宣布特定网络的前缀，我们要非常精确的调整公告以确保全球所有公告从骨干网都是等距（相同跳数）。这是BGP社区由来：我们预先跳跃到某些路线或阻止前缀出口确定NSPs。在某些地区，如南美或非洲，我们必须非常谨慎以防止我们区域外的出口。我们总是需要通过对等交流防止路线“泄漏”否则某些网络通常喜欢其他路径。

**美国**　　　　　　　　　　　　　　　　　　　　　　**国际**

<table>
<tbody>
<tr><td>网络POP</td><td>地点</td><td>网络POP</td><td>地点</td></tr>
<tr><td>SEA01</td><td>西雅图，华盛顿，美国</td><td>GRU01</td><td>圣保罗，巴西</td></tr>
<tr><td>SJC01</td><td>圣何塞，加利福尼亚，美国</td><td>LHR01</td><td>伦敦，英国</td></tr>
<tr><td>LAX01</td><td>洛杉矶，加利福尼亚，美国</td><td>AMS01</td><td>阿姆斯特丹，荷兰</td></tr>
<tr><td>DAL01</td><td>达拉斯，德克萨斯州，美国</td><td>CPT01</td><td>开普敦，南非</td></tr>
<tr><td>MIA01</td><td>迈阿密，佛罗里达州，美国</td><td>NRT01</td><td>东京，日本</td></tr>
<tr><td>ORD01</td><td>芝加哥，伊利诺伊州，美国</td><td>HKG01</td><td>香港，香港</td></tr>
<tr><td>LGA01</td><td>纽约州，纽约，美国</td><td>SIN01</td><td>新加坡，新加坡</td></tr>
<tr><td>IAD01</td><td>赫恩登，弗吉尼亚州，美国</td><td>MAA01</td><td>钦奈，印度</td></tr>
<tr><td></td><td></td><td>SYD01</td><td>悉尼，澳大利亚</td></tr>
<tbody>
</table>

[地点](https://nsone.net/technology/network/)在不断增加中

当我们在部署私有DNS网络时，该网络显得非常独特。通常我们将部署到客户现有的数据中心。有时候，为了服务搜寻和一些其他目的，我们建立纯粹的面向内部DNS网络。我们也碰到不少需要全球分布式网络的客户，但由于监管、政策或技术原因，他们不能使用托管DNS的网络，并且他们还没有全球性使用。我们可以将这些类型的网络部署到公共云供应商，如HostVirtual。我们甚至为具有独特DDoS需求的客户在Black Lotus’s DDoS中心部署权利。

我们使用[ExaBGP](https://github.com/Exa-Networks/exabgp)和一些自定义代码来自动执行某些社区。 ExaBGP包含支持很多网络所不支持的流量说明。

### 我们的团队组成？ ###

我们有一个神奇的团队。其中很多人都来自Voxel公司——几年前被INTERNAP收购。我们已经近十年携手合作，特别是在高容量网络基础设施这一块。我们是一个小团队——一对夫妇工程师，用OPS/DEVOPS/ neteng管理我们的全球网络、销售、市场营销和客户支持。团队中每一个人都在户用上花时间——这是我们真正的价值所在。

### 怎么安排工作？ ###

在输出侧，我们基本的工作就是DNS查询。对于每个查询，我们正在执行一种路由算法的自定义序列（我们成为Filter Chain）来采集答案（例如，负载平衡器IP地址或主机名CDN）和实时数据有关的答案（例如，负载或其他基础设施度量，网络度量等）。其他不太明显的工作量是在数据侧：收录、分类、规范化、汇总和分配容量，实时数据对路由很有用。有时候，每秒有数千数据点进入我们系统，关于如何以及何时通过Filter Chain将数据发送到远处我们必须具备足够的敏锐性。

### 延迟多重要？ ###

在很多方面延迟非常重要。传统托管DNS微分器的性能主要取决于给出答案的速度。在这个行业给出快速答案如同赌注。对我们来说更有趣的以及DNS和流量管理行业应该引领的地方是给出*最佳*答案。除此之外，无论在可靠性（DR环境）或性能（将应用推向边缘）上，应用是从下向上分布。采用现代化云服务提供商和Nginx加速一个自己的新CDN不再那么困难。采用整体现代化数据库来解决多数据中心数据复制和一致性问题也并不困难。用大多数托管DNS供应商的基本GeoIP特点做一些简单的、合理的路由来关注最近的数据中心甚至非常容易。但是，假如你真的想优化应用程序的延迟、吞吐量、任何业务指标和二阶近似想地理距离一样不再运作——这并不是网络的实际工作。你需要衡量这些指标：在纽约的Verizon到每一个不同的数据中心什么是用户的响应时间，现在呢？你需要高频的吸收数据，处理一堆数学，并给用户送到正确的地方。这就是我们所做的。所以说：延迟是对我们非常重要。但也许不是你想象的那样，至少第一眼看上去。

### edns-client-subnet在网络上的当前状态是什么？ ###

edns-client-subnet（ECS）是一个扩展的DNS协议。支持DNS解析器的它（如Google Public DNS和OpenDNS）包含了和原始请求器有关的附加信息，当原始器发送一个询问到一个机构（如NSONE）支持ECS——通常，发送请求器IP地址的前三个字节。这些信息对于流量管理是真正有用的，特别是当你正在做的GeoIP或一些更高级的路由NSONE，因为你有实际的最终用户信息，而不是一些大的集中解析器。

NSONE是支持ECS为数不多的DNS供应商之一，并且我们已经做了一段时间。也学到了一些有趣的东西。

我们几乎只能看到来自Google和OpenDNS的ECS功能的查询。很少有其他解析器支持它。但总的来说，这都没关系：Google/OpenDNS是大型的Anycasted全球性解析器节点网络，因为关系到（地理或其他方式）实际的最终用户这可能不是真的，所以它的价值是从他们的路由获取更多的信息。大多数其他DNS解析器往往与实际的最终用户更加相关，因此使ECS在解析器上好处更少。

![](http://2zmzkp23rtmx20a8qi485hmn.wpengine.netdna-cdn.com/wp-content/uploads/2014/11/ecs-data31.png)

我们得到约10-15％的DNS查询连接了ECS数据。我们开始返回使用ECS数据查询响应时非常有趣，因为解析器只能针对子网缓存响应（一般/24），ECS启用查询的数量增加。如果你有一个大部分来自网络上的子网像广告像素域的DNS记录，ECS可能引起更大的DNS流量（而且路由的准确性更好）。如果你有本地用户的记录，ECS不太会影响你的DNS流量。在一般情况下，我们能够做到比其他方式更精确的路由ECS启用查询，这要归功于Google Public DNS和OpenDNS的流行。

### 新一代NSONE会是什么？ ###

爆料很多绝密的信息！我们雇用想疯子一样的人（不是每个人吗？），因为我们增长于快。我们发现一个非常有趣地方进行工作，我们正在尽可能的努来真正推动流量管理的界限。这意味着针对应用程序工作负载的东西比如真正的路由眼球指标，定制软件定义私有DNS网络，以及许多强大的新算法和工具来运行和思考DNS和流量管理。

### 相关文章 ###

[Backend Teardown: Muut](http://www.scalescale.com/backend-teardown-muut/)

[The Making of OnMetal](http://www.scalescale.com/the-making-of-onmetal/)

[How Ansible Scaled their Opensource Community](http://www.scalescale.com/scaling-ansible-community/)

[Open Source Software to Help You Scale](http://www.scalescale.com/open-source-software-help-scale/)

[Building a Cloud Benchmarking System](http://www.scalescale.com/building-cloud-benchmarking-system/)
